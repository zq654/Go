### **1. 第一级：栈分配（Stack Allocation）**

- **适用场景**：函数内的局部变量（如 `a := 10`、短生命周期的切片 / 结构体）。
- **原理**：
  Go 协程（Goroutine）有独立的**栈空间**（初始很小，默认 2KB 左右，动态扩缩容），局部变量优先在栈上分配。
  栈内存的分配是 “线性的”（通过栈指针 `SP` 移动实现），几乎零开销，函数返回后栈帧自动回收，无需 GC 参与。
- 特点：
  - 分配速度极快（纳秒级）；
  - 内存自动释放（函数执行完毕，栈帧弹出）；
  - 空间有限（动态扩缩容但仍受限于协程栈最大限制）。

### **2. 第二级：堆分配 + 内存池（Heap Allocation + Cache/Pool）**

- **适用场景**：跨函数传递的变量（如返回动态创建的切片、结构体指针）、长生命周期对象。

- 原理：

  Go 的堆分配并非直接向操作系统申请，而是先从Go 运行时（runtime）管理的 “内存缓存”中分配：

  - **MCache（Micro Cache）**：每个 P（逻辑处理器）绑定一个 MCache，存储小对象内存块（按大小分类，如 8B、16B 等），分配时直接从对应规格的块中取，无需锁竞争。
  - **MCentral（Central Cache）**：当 MCache 耗尽时，从 MCentral 补充内存块，**MCentral 按大小分类管理，多个 P 共享，存在锁竞争但频率低**。

- 特点：

  - 分配速度比栈慢，但比直接系统调用快；
  - 依赖 Go 运行时的内存管理（如逃逸分析决定是否分配到堆）；
  - 内存由 GC 回收（标记 - 清除算法）。

### **3. 第三级：向操作系统申请内存（System Allocation）**

- **适用场景**：当 Go 运行时的内存缓存（MCentral、MHeap）耗尽，需要扩容堆空间时。
- **原理**：
  Go 运行时通过 `sysAlloc` 等底层函数，调用操作系统的 **mmap**（类 Unix 系统）或 **VirtualAlloc**（Windows），直接申请大块内存（以 “内存页” 为单位，通常 4KB、2MB 等），补充到 MHeap（全局堆管理结构）中，再向下分配给 MCentral、MCache。
- 特点：
  - 分配开销最大（涉及系统调用、页表映射等）；
  - 触发条件严格（只有当运行时内存池耗尽时才会触发）；
  - 申请的内存最终会被切分成小块，供上层（MCentral、MCache）分配。

在 Go 语言的内存管理体系中，除了`MCache`（Micro Cache）和`MCentral`（Central Cache ），还有**MHeap**，它们共同协作完成内存的分配与管理 。下面为你详细介绍：

### MCache（Micro Cache）

- **含义**：`MCache`是每个逻辑处理器（P）私有的内存缓存。它负责为协程提供小对象（一般指大小不超过`maxSmallSize`，在 Go 1.19 中该值为 32KB）的内存分配。
- **工作原理**：`MCache`内部维护了一系列的`mspan`，每个`mspan`管理着特定大小类别的对象。当协程需要分配小对象内存时，会优先从所在 P 对应的`MCache`中查找合适的`mspan` ，如果存在可用空间，就直接分配，这个过程不需要加锁，因此速度非常快。
- **作用**：极大地提升了小对象内存分配的效率，减少了锁竞争，因为它是每个 P 私有的，避免了多个协程同时访问时的冲突。

### MCentral（Central Cache）

- **含义**：`MCentral`是全局的内存中心缓存，用于为`MCache`补充内存。它按对象大小进行分类管理，每个大小类别对应一个`MCentral`实例。
- **工作原理**：当`MCache`中某个大小类别的`mspan`耗尽时，就会从`MCentral`中获取一个新的`mspan` 。`MCentral`会从`MHeap`获取`mspan`，并维护这些`mspan`的状态，如已分配、空闲等。由于多个`MCache`可能同时请求补充`mspan`，所以`MCentral`的操作需要加锁。
- **作用**：作为`MCache`和`MHeap`之间的中间层，平衡了内存分配的效率和内存的统一管理，减少了`MCache`对`MHeap`的直接频繁请求。

### MHeap（Heap）

- **含义**：`MHeap`是 Go 语言内存管理中与操作系统交互的核心组件，它负责管理 Go 程序的整个堆内存。
- 工作原理
  - **内存申请**：当`MCentral`中的`mspan`耗尽，需要更多内存时，`MHeap`会通过系统调用（如`mmap`在类 Unix 系统上 ）向操作系统申请大块的内存区域。
  - **内存分配**：`MHeap`会将申请到的内存划分为多个`mspan`，并分配给`MCentral`。同时，它还会处理内存的回收，当`MCache`中的`mspan`被释放回`MCentral`，`MCentral`再将空闲的`mspan`归还给`MHeap`，`MHeap`会进行合并等操作，以便后续重新分配。
  - **垃圾回收协作**：在垃圾回收（GC）过程中，`MHeap`会与 GC 协作，标记和清理不再使用的内存。
- **作用**：负责堆内存的总体管理，包括内存的申请、分配、回收以及与操作系统的交互，是 Go 语言内存管理体系的基础和核心。

